# syntax=docker/dockerfile:1

### Build stage
FROM maven:3.9-eclipse-temurin-21 AS build
WORKDIR /app
COPY pom.xml .
RUN mvn -q -DskipTests dependency:go-offline
COPY src ./src
# ç”¢ç”Ÿå¯åŸ·è¡Œçš„ Spring Boot Fat Jar
RUN mvn -q -DskipTests package spring-boot:repackage
# åªæŒ‘ä¸æ˜¯ .original çš„ jarï¼Œå›ºå®šæˆ /app/app.jar
RUN set -eux; JAR="$(ls target/*.jar | grep -v '\.original$' | head -n1)"; \
    cp "$JAR" /app/app.jar

### Run stage
FROM eclipse-temurin:21-jre
WORKDIR /app
COPY --from=build /app/app.jar /app/app.jar
EXPOSE 8080

# ğŸ‘‰ é™åˆ¶ JVM è¨˜æ†¶é«”ï¼šæœ€å° 64MBï¼Œæœ€å¤§ 256MB
ENV JAVA_OPTS="-XX:+UseContainerSupport -Xms64m -Xmx256m"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
